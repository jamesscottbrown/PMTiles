var d=Uint8Array,M=Uint16Array,ve=Uint32Array,me=new d([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ye=new d([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ve=new d([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),de=function(t,e){for(var r=new M(31),n=0;n<31;++n)r[n]=e+=1<<t[n-1];for(var i=new ve(r[30]),n=1;n<30;++n)for(var a=r[n];a<r[n+1];++a)i[a]=a-r[n]<<5|n;return[r,i]},we=de(me,2),xe=we[0],Oe=we[1];xe[28]=258,Oe[258]=28;var be=de(ye,0),Fe=be[0],xt=be[1],J=new M(32768);for(p=0;p<32768;++p)D=(p&43690)>>>1|(p&21845)<<1,D=(D&52428)>>>2|(D&13107)<<2,D=(D&61680)>>>4|(D&3855)<<4,J[p]=((D&65280)>>>8|(D&255)<<8)>>>1;var D,p,Z=function(t,e,r){for(var n=t.length,i=0,a=new M(e);i<n;++i)t[i]&&++a[t[i]-1];var o=new M(e);for(i=0;i<e;++i)o[i]=o[i-1]+a[i-1]<<1;var f;if(r){f=new M(1<<e);var s=15-e;for(i=0;i<n;++i)if(t[i])for(var u=i<<4|t[i],l=e-t[i],c=o[t[i]-1]++<<l,h=c|(1<<l)-1;c<=h;++c)f[J[c]>>>s]=u}else for(f=new M(n),i=0;i<n;++i)t[i]&&(f[i]=J[o[t[i]-1]++]>>>15-t[i]);return f},I=new d(288);for(p=0;p<144;++p)I[p]=8;var p;for(p=144;p<256;++p)I[p]=9;var p;for(p=256;p<280;++p)I[p]=7;var p;for(p=280;p<288;++p)I[p]=8;var p,Ee=new d(32);for(p=0;p<32;++p)Ee[p]=5;var p;var ke=Z(I,9,1);var Ke=Z(Ee,5,1),q=function(t){for(var e=t[0],r=1;r<t.length;++r)t[r]>e&&(e=t[r]);return e},E=function(t,e,r){var n=e/8|0;return(t[n]|t[n+1]<<8)>>(e&7)&r},Y=function(t,e){var r=e/8|0;return(t[r]|t[r+1]<<8|t[r+2]<<16)>>(e&7)},Ge=function(t){return(t+7)/8|0},je=function(t,e,r){(e==null||e<0)&&(e=0),(r==null||r>t.length)&&(r=t.length);var n=new(t.BYTES_PER_ELEMENT==2?M:t.BYTES_PER_ELEMENT==4?ve:d)(r-e);return n.set(t.subarray(e,r)),n};var Ne=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],A=function(t,e,r){var n=new Error(e||Ne[t]);if(n.code=t,Error.captureStackTrace&&Error.captureStackTrace(n,A),!r)throw n;return n},Q=function(t,e,r){var n=t.length;if(!n||r&&r.f&&!r.l)return e||new d(0);var i=!e||r,a=!r||r.i;r||(r={}),e||(e=new d(n*3));var o=function(he){var pe=e.length;if(he>pe){var ge=new d(Math.max(pe*2,he));ge.set(e),e=ge}},f=r.f||0,s=r.p||0,u=r.b||0,l=r.l,c=r.d,h=r.m,x=r.n,m=n*8;do{if(!l){f=E(t,s,1);var g=E(t,s+1,3);if(s+=3,g)if(g==1)l=ke,c=Ke,h=9,x=5;else if(g==2){var C=E(t,s,31)+257,ae=E(t,s+10,15)+4,oe=C+E(t,s+5,31)+1;s+=14;for(var R=new d(oe),W=new d(19),w=0;w<ae;++w)W[Ve[w]]=E(t,s+w*3,7);s+=ae*3;for(var se=q(W),Re=(1<<se)-1,He=Z(W,se,1),w=0;w<oe;){var ue=He[E(t,s,Re)];s+=ue&15;var v=ue>>>4;if(v<16)R[w++]=v;else{var B=0,K=0;for(v==16?(K=3+E(t,s,3),s+=2,B=R[w-1]):v==17?(K=3+E(t,s,7),s+=3):v==18&&(K=11+E(t,s,127),s+=7);K--;)R[w++]=B}}var fe=R.subarray(0,C),T=R.subarray(C);h=q(fe),x=q(T),l=Z(fe,h,1),c=Z(T,x,1)}else A(1);else{var v=Ge(s)+4,b=t[v-4]|t[v-3]<<8,y=v+b;if(y>n){a&&A(0);break}i&&o(u+b),e.set(t.subarray(v,y),u),r.b=u+=b,r.p=s=y*8,r.f=f;continue}if(s>m){a&&A(0);break}}i&&o(u+131072);for(var Ze=(1<<h)-1,Ie=(1<<x)-1,_=s;;_=s){var B=l[Y(t,s)&Ze],S=B>>>4;if(s+=B&15,s>m){a&&A(0);break}if(B||A(2),S<256)e[u++]=S;else if(S==256){_=s,l=null;break}else{var ce=S-254;if(S>264){var w=S-257,H=me[w];ce=E(t,s,(1<<H)-1)+xe[w],s+=H}var X=c[Y(t,s)&Ie],$=X>>>4;X||A(3),s+=X&15;var T=Fe[$];if($>3){var H=ye[$];T+=Y(t,s)&(1<<H)-1,s+=H}if(s>m){a&&A(0);break}i&&o(u+131072);for(var le=u+ce;u<le;u+=4)e[u]=e[u-T],e[u+1]=e[u+1-T],e[u+2]=e[u+2-T],e[u+3]=e[u+3-T];u=le}}r.l=l,r.p=_,r.b=u,r.f=f,l&&(f=1,r.m=h,r.d=c,r.n=x)}while(!f);return u==e.length?e:je(e,0,u)};var We=new d(0);var _e=function(t){(t[0]!=31||t[1]!=139||t[2]!=8)&&A(6,"invalid gzip data");var e=t[3],r=10;e&4&&(r+=t[10]|(t[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!t[r++]);return r+(e&2)},Xe=function(t){var e=t.length;return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0};var $e=function(t){((t[0]&15)!=8||t[0]>>>4>7||(t[0]<<8|t[1])%31)&&A(6,"invalid zlib data"),t[1]&32&&A(6,"invalid zlib data: preset dictionaries not supported")};function qe(t,e){return Q(t,e)}function Ye(t,e){return Q(t.subarray(_e(t),-8),e||new d(Xe(t)))}function Je(t,e){return Q(($e(t),t.subarray(2,-4)),e)}function V(t,e){return t[0]==31&&t[1]==139&&t[2]==8?Ye(t,e):(t[0]&15)!=8||t[0]>>4>7||(t[0]<<8|t[1])%31?qe(t,e):Je(t,e)}var Qe=typeof TextDecoder<"u"&&new TextDecoder,et=0;try{Qe.decode(We,{stream:!0}),et=1}catch{}var De=(t,e)=>t*Math.pow(2,e),O=(t,e)=>Math.floor(t/Math.pow(2,e)),G=(t,e)=>De(t.getUint16(e+1,!0),8)+t.getUint8(e),Ue=(t,e)=>De(t.getUint32(e+2,!0),16)+t.getUint16(e,!0),tt=(t,e,r,n,i)=>{if(t!=n.getUint8(i))return t-n.getUint8(i);let a=G(n,i+1);if(e!=a)return e-a;let o=G(n,i+4);return r!=o?r-o:0},rt=(t,e,r,n)=>{let i=Te(t,e|128,r,n);return i?{z:e,x:r,y:n,offset:i[0],length:i[1],is_dir:!0}:null},Ae=(t,e,r,n)=>{let i=Te(t,e,r,n);return i?{z:e,x:r,y:n,offset:i[0],length:i[1],is_dir:!1}:null},Te=(t,e,r,n)=>{let i=0,a=t.byteLength/17-1;for(;i<=a;){let o=a+i>>1,f=tt(e,r,n,t,o*17);if(f>0)i=o+1;else if(f<0)a=o-1;else return[Ue(t,o*17+7),t.getUint32(o*17+13,!0)]}return null},nt=(t,e)=>t.is_dir&&!e.is_dir?1:!t.is_dir&&e.is_dir?-1:t.z!==e.z?t.z-e.z:t.x!==e.x?t.x-e.x:t.y-e.y,Ce=(t,e)=>{let r=t.getUint8(e*17);return{z:r&127,x:G(t,e*17+1),y:G(t,e*17+4),offset:Ue(t,e*17+7),length:t.getUint32(e*17+13,!0),is_dir:r>>7===1}},ze=t=>{let e=[],r=new DataView(t);for(let n=0;n<r.byteLength/17;n++)e.push(Ce(r,n));return it(e)},it=t=>{t.sort(nt);let e=new ArrayBuffer(17*t.length),r=new Uint8Array(e);for(let n=0;n<t.length;n++){let i=t[n],a=i.z;i.is_dir&&(a=a|128),r[n*17]=a,r[n*17+1]=i.x&255,r[n*17+2]=i.x>>8&255,r[n*17+3]=i.x>>16&255,r[n*17+4]=i.y&255,r[n*17+5]=i.y>>8&255,r[n*17+6]=i.y>>16&255,r[n*17+7]=i.offset&255,r[n*17+8]=O(i.offset,8)&255,r[n*17+9]=O(i.offset,16)&255,r[n*17+10]=O(i.offset,24)&255,r[n*17+11]=O(i.offset,32)&255,r[n*17+12]=O(i.offset,48)&255,r[n*17+13]=i.length&255,r[n*17+14]=i.length>>8&255,r[n*17+15]=i.length>>16&255,r[n*17+16]=i.length>>24&255}return e},at=(t,e)=>{if(t.byteLength<17)return null;let r=t.byteLength/17,n=Ce(t,r-1);if(n.is_dir){let i=n.z,a=e.z-i,o=Math.trunc(e.x/(1<<a)),f=Math.trunc(e.y/(1<<a));return{z:i,x:o,y:f}}return null};async function ot(t){let e=await t.getBytes(0,512e3),r=new DataView(e.data),n=r.getUint32(4,!0),i=r.getUint16(8,!0),a=new TextDecoder("utf-8"),o=JSON.parse(a.decode(new DataView(e.data,10,n))),f=0;o.compression==="gzip"&&(f=2);let s=0;"minzoom"in o&&(s=+o.minzoom);let u=0;"maxzoom"in o&&(u=+o.maxzoom);let l=0,c=0,h=0,x=-180,m=-85,g=180,v=85;if(o.bounds){let y=o.bounds.split(",");x=+y[0],m=+y[1],g=+y[2],v=+y[3]}if(o.center){let y=o.center.split(",");l=+y[0],c=+y[1],h=+y[2]}return{specVersion:r.getUint16(2,!0),rootDirectoryOffset:10+n,rootDirectoryLength:i*17,jsonMetadataOffset:10,jsonMetadataLength:n,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:f,tileType:1,minZoom:s,maxZoom:u,minLon:x,minLat:m,maxLon:g,maxLat:v,centerZoom:h,centerLon:l,centerLat:c,etag:e.etag}}async function st(t,e,r,n,i,a,o){let f=await r.getArrayBuffer(e,t.rootDirectoryOffset,t.rootDirectoryLength,t);t.specVersion===1&&(f=ze(f));let s=Ae(new DataView(f),n,i,a);if(s){let c=(await e.getBytes(s.offset,s.length,o)).data,h=new DataView(c);return h.getUint8(0)==31&&h.getUint8(1)==139&&(c=V(new Uint8Array(c))),{data:c}}let u=at(new DataView(f),{z:n,x:i,y:a});if(u){let l=rt(new DataView(f),u.z,u.x,u.y);if(l){let c=await r.getArrayBuffer(e,l.offset,l.length,t);t.specVersion===1&&(c=ze(c));let h=Ae(new DataView(c),n,i,a);if(h){let m=(await e.getBytes(h.offset,h.length,o)).data,g=new DataView(m);return g.getUint8(0)==31&&g.getUint8(1)==139&&(m=V(new Uint8Array(m))),{data:m}}}}}var ee={getHeader:ot,getZxy:st};function P(t,e){return(e>>>0)*4294967296+(t>>>0)}function ft(t,e){let r=e.buf,n,i;if(i=r[e.pos++],n=(i&112)>>4,i<128||(i=r[e.pos++],n|=(i&127)<<3,i<128)||(i=r[e.pos++],n|=(i&127)<<10,i<128)||(i=r[e.pos++],n|=(i&127)<<17,i<128)||(i=r[e.pos++],n|=(i&127)<<24,i<128)||(i=r[e.pos++],n|=(i&1)<<31,i<128))return P(t,n);throw new Error("Expected varint not more than 10 bytes")}function k(t){let e=t.buf,r,n;return n=e[t.pos++],r=n&127,n<128||(n=e[t.pos++],r|=(n&127)<<7,n<128)||(n=e[t.pos++],r|=(n&127)<<14,n<128)||(n=e[t.pos++],r|=(n&127)<<21,n<128)?r:(n=e[t.pos],r|=(n&15)<<28,ft(r,t))}function ct(t,e,r,n){if(n==0){r==1&&(e[0]=t-1-e[0],e[1]=t-1-e[1]);let i=e[0];e[0]=e[1],e[1]=i}}function lt(t,e,r){if(t>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>Math.pow(2,t)-1||r>Math.pow(2,t)-1)throw Error("tile x/y outside zoom level bounds");let n=0,i=0;for(;i<t;)n+=Math.pow(2,i)*Math.pow(2,i),i++;let a=Math.pow(2,t),o=0,f=0,s=0,u=[e,r],l=a/2;for(;l>0;)o=(u[0]&l)>0?1:0,f=(u[1]&l)>0?1:0,s+=l*l*(3*o^f),ct(l,u,o,f),l=l/2;return n+s}async function ne(t,e){if(e===1||e===0)return t;if(e===2)return V(new Uint8Array(t));throw Error("Compression method not supported")}var ht=127;function pt(t,e){let r=0,n=t.length-1;for(;r<=n;){let i=n+r>>1,a=e-t[i].tileId;if(a>0)r=i+1;else if(a<0)n=i-1;else return t[i]}return n>=0&&(t[n].runLength===0||e-t[n].tileId<t[n].runLength)?t[n]:null}var te=class{constructor(e){this.url=e}getKey(){return this.url}async getBytes(e,r,n){let i;n||(i=new AbortController,n=i.signal);let a=await fetch(this.url,{signal:n,headers:{Range:"bytes="+e+"-"+(e+r-1)}});if(a.status===416&&e===0){let s=a.headers.get("Content-Range");if(!s||!s.startsWith("bytes */"))throw Error("Missing content-length on 416 response");let u=+s.substr(8);a=await fetch(this.url,{signal:n,headers:{Range:"bytes=0-"+(u-1)}})}if(a.status>=300)throw Error("Bad response code: "+a.status);let o=a.headers.get("Content-Length");if(a.status===200&&(!o||+o>r))throw i&&i.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:await a.arrayBuffer(),etag:a.headers.get("ETag")||void 0,cacheControl:a.headers.get("Cache-Control")||void 0,expires:a.headers.get("Expires")||void 0}}};function z(t,e){let r=t.getUint32(e+4,!0),n=t.getUint32(e+0,!0);return r*Math.pow(2,32)+n}function gt(t,e){let r=new DataView(t),n=r.getUint8(7);if(n>3)throw Error(`Archive is spec version ${n} but this library supports up to spec version 3`);return{specVersion:n,rootDirectoryOffset:z(r,8),rootDirectoryLength:z(r,16),jsonMetadataOffset:z(r,24),jsonMetadataLength:z(r,32),leafDirectoryOffset:z(r,40),leafDirectoryLength:z(r,48),tileDataOffset:z(r,56),tileDataLength:z(r,64),numAddressedTiles:z(r,72),numTileEntries:z(r,80),numTileContents:z(r,88),clustered:r.getUint8(96)===1,internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:e}}function Be(t){let e={buf:new Uint8Array(t),pos:0},r=k(e),n=[],i=0;for(let a=0;a<r;a++){let o=k(e);n.push({tileId:i+o,offset:0,length:0,runLength:1}),i+=o}for(let a=0;a<r;a++)n[a].runLength=k(e);for(let a=0;a<r;a++)n[a].length=k(e);for(let a=0;a<r;a++){let o=k(e);o===0&&a>0?n[a].offset=n[a-1].offset+n[a-1].length:n[a].offset=o-1}return n}function vt(t){let e=new DataView(t);return e.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):e.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var U=class extends Error{};async function Le(t,e,r,n){let i=await t.getBytes(0,16384);if(new DataView(i.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(vt(i.data)<3)return[await ee.getHeader(t)];let o=i.data.slice(0,ht),f=i.etag;n&&i.etag!=n&&(console.warn("ETag conflict detected; your HTTP server might not support content-based ETag headers. ETags disabled for "+t.getKey()),f=void 0);let s=gt(o,f);if(r){let u=i.data.slice(s.rootDirectoryOffset,s.rootDirectoryOffset+s.rootDirectoryLength),l=t.getKey()+"|"+(s.etag||"")+"|"+s.rootDirectoryOffset+"|"+s.rootDirectoryLength,c=Be(await e(u,s.internalCompression));return[s,[l,c.length,c]]}return[s,void 0]}async function Se(t,e,r,n,i){let a=await t.getBytes(r,n);if(i.etag&&i.etag!==a.etag)throw new U(a.etag);let o=await e(a.data,i.internalCompression),f=Be(o);if(f.length===0)throw new Error("Empty directory is invalid");return f}var j=class{constructor(e=100,r=!0,n=ne){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.prefetch=r,this.decompress=n}async getHeader(e,r){let n=e.getKey();if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,this.cache.get(n).data;let i=await Le(e,this.decompress,this.prefetch,r);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(n,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]}async getDirectory(e,r,n,i){let a=e.getKey()+"|"+(i.etag||"")+"|"+r+"|"+n;if(this.cache.has(a))return this.cache.get(a).lastUsed=this.counter++,this.cache.get(a).data;let o=await Se(e,this.decompress,r,n,i);return this.cache.set(a,{lastUsed:this.counter++,data:o}),this.prune(),o}async getArrayBuffer(e,r,n,i){let a=e.getKey()+"|"+(i.etag||"")+"|"+r+"|"+n;if(this.cache.has(a))return this.cache.get(a).lastUsed=this.counter++,await this.cache.get(a).data;let o=await e.getBytes(r,n);if(i.etag&&i.etag!==o.etag)throw new U(i.etag);return this.cache.set(a,{lastUsed:this.counter++,data:o.data}),this.prune(),o.data}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,r;this.cache.forEach((n,i)=>{n.lastUsed<e&&(e=n.lastUsed,r=i)}),r&&this.cache.delete(r)}}async invalidate(e,r){this.cache.delete(e.getKey()),await this.getHeader(e,r)}},re=class{constructor(e=100,r=!0,n=ne){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.prefetch=r,this.decompress=n}async getHeader(e,r){let n=e.getKey();if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,await this.cache.get(n).data;let i=new Promise((a,o)=>{Le(e,this.decompress,this.prefetch,r).then(f=>{f[1]&&this.cache.set(f[1][0],{lastUsed:this.counter++,data:Promise.resolve(f[1][2])}),a(f[0]),this.prune()}).catch(f=>{o(f)})});return this.cache.set(n,{lastUsed:this.counter++,data:i}),i}async getDirectory(e,r,n,i){let a=e.getKey()+"|"+(i.etag||"")+"|"+r+"|"+n;if(this.cache.has(a))return this.cache.get(a).lastUsed=this.counter++,await this.cache.get(a).data;let o=new Promise((f,s)=>{Se(e,this.decompress,r,n,i).then(u=>{f(u),this.prune()}).catch(u=>{s(u)})});return this.cache.set(a,{lastUsed:this.counter++,data:o}),o}async getArrayBuffer(e,r,n,i){let a=e.getKey()+"|"+(i.etag||"")+"|"+r+"|"+n;if(this.cache.has(a))return this.cache.get(a).lastUsed=this.counter++,await this.cache.get(a).data;let o=new Promise((f,s)=>{e.getBytes(r,n).then(u=>{if(i.etag&&i.etag!==u.etag)throw new U(u.etag);f(u.data),this.cache.has(a),this.prune()}).catch(u=>{s(u)})});return this.cache.set(a,{lastUsed:this.counter++,data:o}),o}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,r;this.cache.forEach((n,i)=>{n.lastUsed<e&&(e=n.lastUsed,r=i)}),r&&this.cache.delete(r)}}async invalidate(e,r){this.cache.delete(e.getKey()),await this.getHeader(e,r)}},F=class{constructor(e,r,n){typeof e=="string"?this.source=new te(e):this.source=e,n?this.decompress=n:this.decompress=ne,r?this.cache=r:this.cache=new re}async getHeader(){return await this.cache.getHeader(this.source)}async getZxyAttempt(e,r,n,i){let a=lt(e,r,n),o=await this.cache.getHeader(this.source);if(o.specVersion<3)return ee.getZxy(o,this.source,this.cache,e,r,n,i);if(e<o.minZoom||e>o.maxZoom)return;let f=o.rootDirectoryOffset,s=o.rootDirectoryLength;for(let u=0;u<=3;u++){let l=await this.cache.getDirectory(this.source,f,s,o),c=pt(l,a);if(c)if(c.runLength>0){let h=await this.source.getBytes(o.tileDataOffset+c.offset,c.length,i);if(o.etag&&o.etag!==h.etag)throw new U(h.etag);return{data:await this.decompress(h.data,o.tileCompression),cacheControl:h.cacheControl,expires:h.expires}}else f=o.leafDirectoryOffset+c.offset,s=c.length;else return}throw Error("Maximum directory depth exceeded")}async getZxy(e,r,n,i){try{return await this.getZxyAttempt(e,r,n,i)}catch(a){if(a instanceof U)return this.cache.invalidate(this.source,a.message),await this.getZxyAttempt(e,r,n,i);throw a}}async getMetadataAttempt(){let e=await this.cache.getHeader(this.source),r=await this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength);if(e.etag&&e.etag!==r.etag)throw new U(r.etag);let n=await this.decompress(r.data,e.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(n))}async getMetadata(){try{return await this.getMetadataAttempt()}catch(e){if(e instanceof U)return this.cache.invalidate(this.source,e.message),await this.getMetadataAttempt();throw e}}};var N=class extends Error{constructor(e){super(e)}},mt=(t,e)=>e?e.replaceAll("{name}",t):t+".pmtiles",yt=/^\/(?<NAME>[0-9a-zA-Z\/!\-_\.\*\'\(\)]+)\/(?<Z>\d+)\/(?<X>\d+)\/(?<Y>\d+).(?<EXT>[a-z]+)$/,dt=(t,e)=>{let r=yt;e&&(e=e.replace(/[.*+?^$()|[\]\\]/g,"\\$&"),e=e.replace("{name}","(?<NAME>[0-9a-zA-Z/!-_.*'()]+)"),e=e.replace("{z}","(?<Z>\\d+)"),e=e.replace("{x}","(?<X>\\d+)"),e=e.replace("{y}","(?<Y>\\d+)"),e=e.replace("{ext}","(?<EXT>[a-z]+)"),r=new RegExp(e));let n=t.match(r);if(n){let i=n.groups;return{ok:!0,name:i.NAME,tile:[+i.Z,+i.X,+i.Y],ext:i.EXT}}return{ok:!1,name:"",tile:[0,0,0],ext:""}};async function Pe(t,e){if(e===1||e===0)return t;if(e===2){let n=new Response(t).body.pipeThrough(new DecompressionStream("gzip"));return new Response(n).arrayBuffer()}else throw Error("Compression method not supported")}var wt=new j(25,void 0,Pe),ie=class{constructor(e,r){this.env=e,this.archive_name=r}getKey(){return this.archive_name}async getBytes(e,r){let n=await this.env.BUCKET.get(mt(this.archive_name,this.env.PMTILES_PATH),{range:{offset:e,length:r}});if(!n)throw new N("Archive not found");let i=n;return{data:await i.arrayBuffer(),etag:i.etag,cacheControl:i.httpMetadata?.cacheControl,expires:i.httpMetadata?.cacheExpiry?.toISOString()}}},Ot={async fetch(t,e,r){if(t.method.toUpperCase()==="POST")return new Response(void 0,{status:405});let n=new URL(t.url),{ok:i,name:a,tile:o,ext:f}=dt(n.pathname,e.TILE_PATH),s=caches.default;if(i){let u="";if(typeof e.ALLOWED_ORIGINS<"u")for(let g of e.ALLOWED_ORIGINS.split(","))(g===t.headers.get("Origin")||g==="*")&&(u=g);let l=await s.match(t.url);if(l){let g=new Headers(l.headers);return u&&g.set("Access-Control-Allow-Origin",u),g.set("Vary","Origin"),new Response(l.body,{headers:g,status:l.status})}let c=(g,v,b)=>{v.set("Cache-Control","max-age="+(e.CACHE_MAX_AGE|86400));let y=new Response(g,{headers:v,status:b});r.waitUntil(s.put(t.url,y));let C=new Headers(v);return u&&C.set("Access-Control-Allow-Origin",u),C.set("Vary","Origin"),new Response(g,{headers:C,status:b})},h=new Headers,x=new ie(e,a),m=new F(x,wt,Pe);try{let g=await m.getHeader();if(o[0]<g.minZoom||o[0]>g.maxZoom)return c(void 0,h,404);for(let b of[[1,"mvt"],[2,"png"],[3,"jpg"],[4,"webp"]])if(g.tileType===b[0]&&f!==b[1]){if(g.tileType==1&&f==="pbf")continue;return c("Bad request: archive has type ."+b[1],h,400)}let v=await m.getZxy(o[0],o[1],o[2]);switch(g.tileType){case 1:h.set("Content-Type","application/x-protobuf");break;case 2:h.set("Content-Type","image/png");break;case 3:h.set("Content-Type","image/jpeg");break;case 4:h.set("Content-Type","image/webp");break}return v?c(v.data,h,200):c(void 0,h,204)}catch(g){if(g instanceof N)return c("Archive not found",h,404);throw g}}return new Response("Invalid URL",{status:404})}};export{Ot as default,mt as pmtiles_path,dt as tile_path};
//# sourceMappingURL=index.js.map
